#!/bin/bash

echo "
source src_swisssearch
{
    type = pgsql
    sql_host = $1
    sql_user = $PGUSER
    sql_pass = $PGPASS
    sql_db = search
    sql_port = 5432
    sql_query_pre = SET NAMES 'UTF8'
    sql_attr_bigint = id
    sql_attr_uint = rank
    sql_attr_string = label
    sql_attr_string = origin
    sql_attr_string = geom_st_box2d
    sql_field_string = geom_quadindex
    sql_field_string = detail
}

source src_address : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , strname1||' '||deinr||' <b>'||plz||' '||ort_27||'</b>' as label \
        , origin as origin \
        , quadindex(the_geom) as geom_quadindex \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'address'
}

source src_parcel : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , gemname||' '||name as label \
        , origin as origin \
        , quadindex(the_geom) as geom_quadindex \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'parcel'
}

source src_sn25 : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , '<b>'||name||'</b> ('||kanton||') - '||gemname as label \
        , origin as origin \
        , quadindex(the_geom) as geom_quadindex \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'sn25'
}

source src_gg25 : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , '<b>'||gemname||' ('||kanton||')</b>' as label \
        , origin as origin \
        , quadindex(the_geom) as geom_quadindex \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'gg25'
}

source src_kantone : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , remove_accents(search_name) as detail \
        , '<b>'||name||'</b>' as label \
        , origin as origin \
        , quadindex(the_geom) as geom_quadindex \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'kantone'
}

source src_district : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , '<b>'||name||'</b>' as label \
        , origin as origin \
        , quadindex(the_geom) as geom_quadindex \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'district'
}

source src_zipcode : src_swisssearch
{
    sql_query = \
        SELECT \
        gid as id \
        , search_name as detail \
        , '<b>'||plz||' - '||ort_27||' ('||kanton||')</b>' as label \
        , origin as origin \
        , quadindex(the_geom) as geom_quadindex \
        , st_box2d(the_geom) as geom_st_box2d \
        , rank as rank \
        , gid as id \
        from swiss_search \
        where origin = 'zipcode'
}

source layers
{
    type = pgsql
    sql_host = $1
    sql_user = $PGUSER
    sql_pass = $PGPASS
    sql_db = bod
    sql_port = 5432
    sql_query_pre = SET NAMES 'UTF8'
    sql_attr_bigint = id
    sql_attr_string = lang
    sql_attr_string = origin
    sql_attr_string = label
    sql_field_string = staging
    sql_field_string = topics
    sql_field_string = layer
    sql_field_string = detail
}

source src_layers_de : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'de' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_de
}

source src_layers_fr : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'fr' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_fr
}

source src_layers_en : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'en' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_en
}

source src_layers_it : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'it' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_it
}

source src_layers_rm : layers
{
    sql_query = \
        SELECT \
            bgdi_id::bigint as id \
            , '<b>'||kurzbezeichnung||'</b>' as label \
            , 'layer' as origin \
            , volltextsuche as detail \
            , bod_layer_id as layer \
            , 'rm' as lang \
            , projekte as topics \
            , staging as staging \
            , bgdi_id::bigint as id \
        from re3.view_bod_layer_info_rm
}

source src_ch_astra_ivs-nat
{
    type = pgsql
    # pgcluster0t
    sql_host = $1
    sql_user = $PGUSER
    sql_pass = $PGPASS
    sql_db = uvek
    sql_port = 5432
    sql_query_pre = SET NAMES 'UTF8' 
    sql_query = \
        SELECT \
            nat_id::bigint as id \
            , ivs_slaname as label \
            , 'feature' as origin \
            , remove_accents(ivs_slaname)||' '||remove_accents(ivs_nummer)||' '||remove_accents(ivs_signatur) as detail \
            , 'ch.astra.ivs-nat' as layer \
            , quadindex(the_geom) as geom_quadindex \
            , st_box2d(the_geom) as geom_st_box2d   \
            , nat_id::bigint as id \
        from astra.ivs_nat
    sql_attr_bigint = id
    sql_attr_string = origin
    sql_attr_string = layer
    sql_attr_string = geom_st_box2d
    sql_field_string = geom_quadindex
    sql_field_string = detail 
}

source src_ch_astra_ivs-reg_loc
{
    type = pgsql
    sql_host = $1
    sql_user = $PGUSER
    sql_pass = $PGPASS
    sql_db = uvek
    sql_port = 5432
    sql_query_pre = SET NAMES 'UTF8'
    sql_query = \
        SELECT reg_loc_id::bigint as id \
            , ivs_slaname as label \
            , 'feature' as origin \
            , remove_accents(ivs_slaname)||' '||remove_accents(ivs_nummer)||' '||remove_accents(ivs_signatur) as detail \
            , 'ch.astra.ivs-reg_loc' as layer \
            , quadindex(the_geom) as geom_quadindex \
            , st_box2d(the_geom) as geom_st_box2d \
            , reg_loc_id::bigint as id \
        from astra.ivs_reg_loc
    sql_attr_bigint = id
    sql_attr_string = origin
    sql_attr_string = layer
    sql_attr_string = geom_st_box2d
    sql_field_string = geom_quadindex
    sql_field_string = detail
}

index zipcode
{
    source = src_zipcode
    path = /var/sig/shp/sphinx/data/zipcode
    type = plain
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 1
    infix_fields = detail, geom_quadindex
    enable_star = 1
}

index district : zipcode
{
    source = src_district
    path = /var/sig/shp/sphinx/data/district
}

index kantone : zipcode
{
    source = src_kantone
    path = /var/sig/shp/sphinx/data/kantone
}

index gg25 : zipcode
{
    source = src_gg25
    path = /var/sig/shp/sphinx/data/gg25
}

index sn25 : zipcode
{
    source = src_sn25
    path = /var/sig/shp/sphinx/data/sn25
}

index parcel : zipcode
{
    source = src_parcel
    path = /var/sig/shp/sphinx/data/parcel
}

index address : zipcode
{
    source = src_address
    path = /var/sig/shp/sphinx/data/address
}

index swisssearch
{
    type = distributed
    local = zipcode
    local = district
    local = kantone
    local = gg25
    local = sn25
    local = parcel
    local = address
}

index layers_de
{
    type = plain
    source = src_layers_de
    path = /var/sig/shp/sphinx/data/layers_de
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 1
    infix_fields = detail, layer, topics, staging
}

index layers_fr
{
    type = plain
    source = src_layers_fr
    path = /var/sig/shp/sphinx/data/layers_fr
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 1
    infix_fields = detail, layer, topics, staging
}

index layers_en
{
    type = plain
    source = src_layers_en
    path = /var/sig/shp/sphinx/data/layers_en
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 1
    infix_fields = detail, layer, topics, staging
}

index layers_it
{
    type = plain
    source = src_layers_it
    path = /var/sig/shp/sphinx/data/layers_it
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 1
    infix_fields = detail, layer, topics, staging
}

index layers_rm
{
    type = plain
    source = src_layers_rm
    path = /var/sig/shp/sphinx/data/layers_rm
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 1
    infix_fields = detail, layer, topics, staging
}

index ch_astra_ivs-nat
{
    type = plain # Which is also the default value
    source = src_ch_astra_ivs-nat
    path = /var/sig/shp/sphinx/data/ch_astra_ivs-nat
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 3 # At least 3 letters within a word
    infix_fields = detail
}

index ch_astra_ivs-reg_loc
{
    type = plain # Which is also the default value
    source = src_ch_astra_ivs-reg_loc
    path = /var/sig/shp/sphinx/data/ch_astra_ivs-reg_loc
    docinfo = extern
    charset_type = utf-8
    min_infix_len = 3 # At least 3 letters within a word
    infix_fields = detail
}

indexer
{
    mem_limit = 512M
    max_iosize = 1048576
}

searchd
{
    port = 3312
    log = /var/sig/shp/sphinx/log/searchd.log
    query_log = /var/sig/shp/sphinx/log/query.log
    pid_file = /var/sig/shp/sphinx/log/searchd.pid
    dist_threads = 3
    read_timeout = 5
    max_children = 90
    max_matches = 10000
}
"
